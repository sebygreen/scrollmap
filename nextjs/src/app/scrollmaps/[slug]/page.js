// dependencies
import PocketBase from "pocketbase";
import styles from "@/styles/Scrollmap.module.css";
import Button from "@/components/Button";
import Viewer from "@/components/Viewer";

export const revalidate = 3600; // revalidate every hour

async function getScrollmap(slug) {
    const pb = new PocketBase("http://pocketbase:8090");
    try {
        const records = await pb
            .collection("scrollmaps")
            .getFirstListItem(`slug ~ "${slug}"`);
        return records;
    } catch (e) {
        throw new Error(e);
    }
}

export async function generateMetadata({ params }) {
    var scrollmap = await getScrollmap(params.slug);
    return { title: scrollmap.name };
}

function Icon() {
    return (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
        >
            <path
                fillRule="evenodd"
                d="M20.25 12a.75.75 0 01-.75.75H6.31l5.47 5.47a.75.75 0 11-1.06 1.06l-6.75-6.75a.75.75 0 010-1.06l6.75-6.75a.75.75 0 111.06 1.06l-5.47 5.47H19.5a.75.75 0 01.75.75z"
                clipRule="evenodd"
            />
        </svg>
    );
}

export default async function Page({ params }) {
    if (!params) {
        return <h2>Error loading page parameters.</h2>;
    } else {
        const scrollmap = await getScrollmap(params.slug);
        if (scrollmap.error) {
            return <h2>Error loading item.</h2>;
        } else {
            return (
                <section className={styles.grid}>
                    <div className={styles.titlebar}>
                        <h1>{scrollmap.name}</h1>
                        <Button
                            type="link"
                            href="/scrollmaps"
                            text="Back"
                            icon={<Icon />}
                        />
                    </div>
                    <div className={styles.metadata}>
                        <div className={styles.data}>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    fillRule="evenodd"
                                    d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z"
                                    clipRule="evenodd"
                                />
                            </svg>
                            <h2>{scrollmap.location}</h2>
                        </div>
                        <div className={styles.data}>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    fillRule="evenodd"
                                    d="M11.622 1.602a.75.75 0 01.756 0l2.25 1.313a.75.75 0 01-.756 1.295L12 3.118 10.128 4.21a.75.75 0 11-.756-1.295l2.25-1.313zM5.898 5.81a.75.75 0 01-.27 1.025l-1.14.665 1.14.665a.75.75 0 11-.756 1.295L3.75 8.806v.944a.75.75 0 01-1.5 0V7.5a.75.75 0 01.372-.648l2.25-1.312a.75.75 0 011.026.27zm12.204 0a.75.75 0 011.026-.27l2.25 1.312a.75.75 0 01.372.648v2.25a.75.75 0 01-1.5 0v-.944l-1.122.654a.75.75 0 11-.756-1.295l1.14-.665-1.14-.665a.75.75 0 01-.27-1.025zm-9 5.25a.75.75 0 011.026-.27L12 11.882l1.872-1.092a.75.75 0 11.756 1.295l-1.878 1.096V15a.75.75 0 01-1.5 0v-1.82l-1.878-1.095a.75.75 0 01-.27-1.025zM3 13.5a.75.75 0 01.75.75v1.82l1.878 1.095a.75.75 0 11-.756 1.295l-2.25-1.312a.75.75 0 01-.372-.648v-2.25A.75.75 0 013 13.5zm18 0a.75.75 0 01.75.75v2.25a.75.75 0 01-.372.648l-2.25 1.312a.75.75 0 11-.756-1.295l1.878-1.096V14.25a.75.75 0 01.75-.75zm-9 5.25a.75.75 0 01.75.75v.944l1.122-.654a.75.75 0 11.756 1.295l-2.25 1.313a.75.75 0 01-.756 0l-2.25-1.313a.75.75 0 11.756-1.295l1.122.654V19.5a.75.75 0 01.75-.75z"
                                    clipRule="evenodd"
                                />
                            </svg>
                            <h2>
                                {scrollmap.height}px tall &bull;{" "}
                                {scrollmap.width}px wide
                            </h2>
                        </div>
                        <div className={styles.data}>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    fillRule="evenodd"
                                    d="M5.25 2.25a3 3 0 00-3 3v4.318a3 3 0 00.879 2.121l9.58 9.581c.92.92 2.39 1.186 3.548.428a18.849 18.849 0 005.441-5.44c.758-1.16.492-2.629-.428-3.548l-9.58-9.581a3 3 0 00-2.122-.879H5.25zM6.375 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z"
                                    clipRule="evenodd"
                                />
                            </svg>

                            <h2>Version {scrollmap.version}</h2>
                        </div>
                    </div>
                    <Viewer scrollmap={scrollmap} />
                </section>
            );
        }
    }
}
